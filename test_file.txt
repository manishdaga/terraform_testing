SELECT * FROM (SELECT
COALESCE(cpi.project_id,fpp.project_id) "project_id"
, fp.customer_display_name "customer_name"
, fps.primary_pm
, fps.primary_service_expert_name
, fp.primary_designer
, fp.primary_cm
, cpi.room_name
, cpi.name "item_name"
, (CASE WHEN fbp.meta_data LIKE '%mark_up%' THEN 1 ELSE 0 END) "is_csv_uploaded_boq"
, replace(cast(json_extract(cpi.entity_context_data, '$.description') as varchar),'"','') "item_description"
, cpi.quantity "item_quantity"
, replace(cast(json_extract(fbp.sku_definition,'$.unit') as varchar),'"','') "unit_of_measure"
, cpi.selling_price "item_selling_price"
, replace(cast(json_extract(fbp.meta_data,'$.vendor_name') as varchar),'"','') "vendor_name"
, replace(cast(json_extract(fbp.meta_data,'$.reference_sku_code') as varchar),'"','') "reference_sku_code"
, fbp.filename "image_url"
, COALESCE(cpi.sku_code,CAST(i.id AS VARCHAR)) "canvas_sku_code"
, i.name "trackpad_group_name"
, ttm.name "milestone_name"
, ctg.name "group_category_name"
, ttt.name "task_name"
, ttt.updated_at "task_updated_at"
, ttt.original_start_date "task_og_start_date"
, ttt.original_end_date "task_og_end_date"
, ttt.start_date "task_start_date"
, ttt.end_date "task_end_date"
, ttg.status "task_status"
, comm.comment "task_comment"
, file.urls "task_documents"
, fpp.plan_status "trackpad_project_status"
, fpp.city_name "project_city"
, split_part(cast(current_timestamp AT TIME ZONE 'Asia/Riyadh' as varchar),'.',1) "Sheet Updated (Riyadh Time)"
FROM
flat_tables.flat_canvas_product_item cpi
LEFT JOIN cms_backend.boq_product fbp on fbp.code = cpi.sku_code
FULL join public_trackpad.items i on cpi.id = i.source_system_ref_id 
LEFT JOIN public_trackpad.categories ctg ON i.category_id = ctg.id 
LEFT JOIN timeline_kronosj.timeline_task ttg on ttg.id = i.timeline_group_id and ttg.is_deleted = 'false'
LEFT JOIN timeline_kronosj.timeline_task ttm on ttg.parent_slug = ttm.slug AND ttm.timeline_id = ttg.timeline_id and ttm.is_deleted = 'false'
LEFT JOIN timeline_kronosj.timeline_task ttt on ttt.parent_slug = ttg.slug AND ttt.timeline_id = ttg.timeline_id and ttt.is_deleted = 'false'
LEFT JOIN public_trackpad.comments comm ON comm.entity_id = CAST(ttt.id AS varchar) and comm.is_deleted = 'false'
LEFT JOIN flat_tables.flat_project_plan fpp on fpp.id = i.project_id
LEFT JOIN flat_tables.flat_projects fp on fp.project_id = COALESCE(cpi.project_id,fpp.project_id)
LEFT JOIN flat_tables.flat_project_settings fps on fps.project_id = COALESCE(cpi.project_id,fpp.project_id)
LEFT JOIN
(select context_id "project_id"
, array_join(array_agg(url),' , ') "urls"
, replace(json_format(json_extract(metadata,'$.task_slug')),'"','') "task_slug"
, replace(json_format(json_extract(metadata,'$.timeline_id')),'"','') "timeline_id"
from "public_kamartaj"."files"
group by 1,3,4) file on file.project_id = cpi.project_id AND ttt.slug = file.task_slug AND cast(ttt.timeline_id as varchar) = file.timeline_id
where (cpi.purchase_order_id IS NOT NULL OR i.id IS NOT NULL) AND cpi.parent_sku_code IS NULL AND fp.country_code = 'SA' and  i.is_deleted = 'false'
ORDER BY COALESCE(cpi.project_id,fpp.project_id) ASC, cpi.sku_code ASC) WHERE project_id=1965295